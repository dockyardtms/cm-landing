AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Static website infrastructure for DockyardTMS frontend
Parameters:
  DomainName:
    Type: String
    Description: The domain name for the website
  Environment:
    Type: String
    Description: Environment name
  HostedZoneId:
    Type: String
    Description: The Route53 Hosted Zone ID for the domain
Resources:
  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${DomainName}-${Environment}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - '*'
          AllowedMethods:
          - GET
          - HEAD
          AllowedOrigins:
          - '*'
          ExposedHeaders:
          - Date
          MaxAge: 3600
  SSLCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName:
        Ref: DomainName
      ValidationMethod: DNS
      DomainValidationOptions:
      - DomainName:
          Ref: DomainName
        HostedZoneId:
          Ref: HostedZoneId
      Tags:
      - Key: Name
        Value:
          Fn::Sub: ${DomainName}-${Environment}
      - Key: Environment
        Value:
          Ref: Environment
  OriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name:
          Fn::Sub: ${DomainName}-${Environment}-oac
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
        - Ref: DomainName
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          CachedMethods:
          - GET
          - HEAD
          Compress: true
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
        DefaultRootObject: index.html
        Enabled: true
        HttpVersion: http2
        Origins:
        - Id: S3Origin
          DomainName:
            Fn::GetAtt:
            - WebsiteBucket
            - RegionalDomainName
          S3OriginConfig:
            OriginAccessIdentity: ''
          OriginAccessControlId:
            Ref: OriginAccessControl
        PriceClass: PriceClass_All
        ViewerCertificate:
          AcmCertificateArn:
            Ref: SSLCertificate
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        CustomErrorResponses:
        - ErrorCode: 403
          ResponseCode: 200
          ResponsePagePath: /index.html
        - ErrorCode: 404
          ResponseCode: 200
          ResponsePagePath: /index.html
      Tags:
      - Key: Name
        Value:
          Fn::Sub: ${DomainName}-${Environment}
      - Key: Environment
        Value:
          Ref: Environment
  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    DependsOn: CloudFrontDistribution
    Properties:
      Bucket:
        Ref: WebsiteBucket
      PolicyDocument:
        Statement:
        - Sid: AllowCloudFrontServicePrincipal
          Effect: Allow
          Principal:
            Service: cloudfront.amazonaws.com
          Action: s3:GetObject
          Resource:
            Fn::Sub: ${WebsiteBucket.Arn}/*
          Condition:
            StringEquals:
              AWS:SourceArn:
                Fn::Sub: arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}
  DNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId:
        Ref: HostedZoneId
      Name:
        Ref: DomainName
      Type: A
      AliasTarget:
        DNSName:
          Fn::GetAtt:
          - CloudFrontDistribution
          - DomainName
        HostedZoneId: Z2FDTNDATAQYW2
Outputs:
  WebsiteBucketName:
    Description: Name of the S3 bucket
    Value:
      Ref: WebsiteBucket
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-WebsiteBucket
  CloudFrontDistributionId:
    Description: CloudFront Distribution ID
    Value:
      Ref: CloudFrontDistribution
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-CloudFrontDistributionId
  CloudFrontDomainName:
    Description: CloudFront Distribution Domain Name
    Value:
      Fn::GetAtt:
      - CloudFrontDistribution
      - DomainName
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-CloudFrontDomainName
  SSLCertificateArn:
    Description: SSL Certificate ARN
    Value:
      Ref: SSLCertificate
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-SSLCertificateArn
  WebsiteURL:
    Description: Website URL
    Value:
      Fn::Sub: https://${DomainName}
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-WebsiteURL
